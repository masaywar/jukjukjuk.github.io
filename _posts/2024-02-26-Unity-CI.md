---
layout: post
title: "Unity-Jenkins CI 환경 구성하기 (2)"
date: 2024-02-26 13:41:00 +0900
categories: unity 
---

이전에 Jenkins 설정에 대해 알아보았고 이제는 Agent 노드에서 Unity 설정을 알아보자. 각 Agent 노드에서 Unity를 Shell을 이용해 Command로 실행을 시켜야 하는데, 이를 위해서는 어떤 Shell 스크립트가 실행이 되어야 하는지를 Master 노드에서 정해줘야 한다. 

먼저 환경 변수를 설정하자.

---

# Jenkins 환경 변수 설정

Jenkins에서는 환경 변수를 두가지 방법으로 설정할 수 있는데, 첫 번째는 전역 환경변수를 설정하는 것이고 두 번째는 각 노드마다 환경변수를 설정하는 것이다. 나는 각 노드마다 다른 플랫폼의 Unity를 빌드할 예정이니 노드마다 환경변수를 설정할 것이다.

&nbsp; 
빌드를 진행할 Node의 <b>Configuration으로</b> 들어간다음 <b>Node Properties</b>의 <b>Environment variables</b>를 활성화 한다. 그러면 Name 과 Value를 입력할 수 있는데, Name에 변수명을 기입하고 Value에는 path등 원하는 값을 넣으면 된다. 나는 PROJECT_PATH, UNITY_PATH 그리고 BUILD_PATH_ARG 이렇게 세 가지를 넣었다.
&nbsp;  

|Variable name|Value|
|---|---|
|UNITY_PATH   |Path where Unity executable is installed|
|PROJECT_PATH |Path where target project is placed|
|BUILD_PATH_ARG |Argument that reprent for the path where built application is saved|

<font size=2 text-align=right>~~테이블 줄이 잘 안보인다...~~</font>


&nbsp; 

다시 프로젝트로 돌아가 설정을 마춰줘야 한다. 먼저 <b>Restrict where this project can be run</b> 이 부분을 활성화 해준다음 잡을 돌릴 Label을 기입하면 된다. 그리고 <b>Build Steps</b>를 열어 <b>Execute Shell</b>을 열어 커맨드를 작성하면 된다.

```sh
#!/bin/bash

# Path to Unity Editor. Replace with your actual Unity editor path

export BUILD_PATH=$BUILD_PATH_ARG

cd $UNITY_PATH || exit

# Execute the build
"$UNITY_EXEC" -batchmode -nographics -silent-crashes -projectPath "$PROJECT_PATH" -executeMethod BuildScript.PerformBuild -quit 

if [ $? -ne 0 ]; then
    echo "Build failed"
    exit 1
else
    echo "Build Succeeded"
    exit 0
fi

```

https://docs.unity3d.com/kr/2023.2/Manual/EditorCommandLineArguments.html

위 링크는 Unity 커맨드라인에 관련된 인자들을 정리한 유니티 문서이다. 각자 알맞게 사용하면 될 것이다.

Jenkins에서의 설정은 얼추 끝났고, Unity에서의 설정을 보자.

---

# Unity Build Script 작성

나는 Target Device를 Windows와 Android로 설정하였지만 현재 테스트 환경이 리눅스인지라 리눅스를 상정하고 하겠다. 테스트 결과는 빌드 파일이 성공적으로 나왔지만 만약 Android가 추가적인 설정이 필요하면 추후에 작성하도록 하겠다. 아래는 내가 썻던 빌드 스크립트이다.

```csharp
using System;
using UnityEditor;
using System.Linq;

public class BuildScript
{
    public static void PerformBuild()
    {
        string buildPath = Environment.GetEnvironmentVariable("BUILD_PATH");

        if(string.IsNullOrWhiteSpace(buildPath))
        {
            throw new ArgumentNullException(paramName:"BUILD_PATH");
        }
        
        string[] defaultScene = EditorBuildSettings.scenes
            .Where(s => s.enabled)
            .Select(s => s.path)
            .ToArray();

        BuildTarget buildTarget = EditorUserBuildSettings.activeBuildTarget;

        BuildPlayerOptions buildPlayerOptions = new BuildPlayerOptions
        {
            scenes = defaultScene,
            locationPathName = buildPath, // Output path
            target = buildTarget, // Target platform
            options = BuildOptions.None
        };

        BuildPipeline.BuildPlayer(buildPlayerOptions);
    }
}

```

---

# 테스트 결과

<img src="/public/img/test_result.png" width="100%">
<img src="/public/img/test.png" width="50%">

시행착오 끝에 기본적인 세팅은 끝난 것 같다...

억울하지만 Linux에서는 Windows Il2cpp 빌드가 되지 않는다 들었다. 현재 사용가능한 머신은 하나뿐이니 Windows 다시 세팅하고 오겠다...
